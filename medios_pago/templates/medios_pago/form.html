{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
.field-info {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

.field-info-hidden {
    display: none;
}

.template-selector {
    background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
    border: 2px dashed #2196f3;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.campo-predefinido {
    position: relative;
}

.campo-predefinido .badge {
    position: absolute;
    top: -8px;
    right: -8px;
    z-index: 10;
}

.marked-for-deletion {
    opacity: 0.6;
    background-color: #fff3cd !important;
    border: 2px dashed #ffc107 !important;
}

.contextual-alert {
    border-left: 4px solid #007bff;
}

.template-creator {
    background: linear-gradient(135deg, #fff8e1, #ffe0b2);
    border: 2px solid #ff9800;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-top: 1rem;
    box-shadow: 0 4px 8px rgba(255, 152, 0, 0.1);
    animation: slideDown 0.3s ease-out;
}

.template-creator.show {
    display: block !important;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.template-creator .form-label.fw-bold {
    color: #e65100;
    font-size: 1.1rem;
}

.template-creator .form-control {
    border: 2px solid #ffb74d;
    border-radius: 0.5rem;
    padding: 0.75rem;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.template-creator .form-control:focus {
    border-color: #ff9800;
    box-shadow: 0 0 0 0.25rem rgba(255, 152, 0, 0.15);
    background-color: #fff;
}

.no-fields-message {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<h1 class="h3 mb-4 text-center">{{ action }} Medio de Cobro</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="card shadow-sm mx-auto" style="max-width: 900px;">
    <div class="card-body">
        <form method="post" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}

            <!-- Informaci√≥n b√°sica del medio de pago -->
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}</label>
                        {{ form.nombre }}
                        {% if form.nombre.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.nombre.errors }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-12 mb-3">
                    <label for="{{ form.tipo_medio.id_for_label }}" class="form-label">
                        <i class="fas fa-cogs me-1"></i>{{ form.tipo_medio.label }}
                    </label>
                    {{ form.tipo_medio }}
                    {% if form.tipo_medio.help_text %}
                        <div class="form-text">{{ form.tipo_medio.help_text }}</div>
                    {% endif %}
                    {% if form.tipo_medio.errors %}
                        <div class="text-danger small mt-1">
                            {{ form.tipo_medio.errors }}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="{{ form.comision_porcentaje.id_for_label }}" class="form-label">{{ form.comision_porcentaje.label }}</label>
                        {{ form.comision_porcentaje }}
                        {% if form.comision_porcentaje.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.comision_porcentaje.errors }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <div class="form-check">
                    {{ form.is_active }}
                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                        {{ form.is_active.label }}
                    </label>
                </div>
            </div>

            <!-- Selector de template (solo en creaci√≥n) -->
            {% if not is_edit %}
                <div class="template-selector">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-magic text-primary me-2"></i>
                            <h5 class="mb-0">Configuraci√≥n R√°pida</h5>
                        </div>
                        <button type="button" id="toggle-template-creator" class="btn btn-warning btn-sm">
                            <i class="fas fa-plus-circle me-1"></i>
                            Crear Template Personalizado
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.aplicar_template.id_for_label }}" class="form-label">{{ form.aplicar_template.label }}</label>
                        {{ form.aplicar_template }}
                        {% if form.aplicar_template.help_text %}
                            <div class="form-text">{{ form.aplicar_template.help_text }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-info alert-sm mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Tip:</strong> Selecciona un template para autocompletar campos comunes, o elige "Personalizado" para agregar campos manualmente.
                    </div>
                </div>

                <!-- Secci√≥n para crear template personalizado -->
                <div class="template-creator" id="template-creator" style="display: none;">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-plus-circle text-warning me-2"></i>
                        <h5 class="mb-0">Crear Template Personalizado</h5>
                        <span class="badge bg-warning text-dark ms-2">Nuevo</span>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.crear_template.id_for_label }}" class="form-label fw-bold">{{ form.crear_template.label }}</label>
                        {{ form.crear_template }}
                        {% if form.crear_template.help_text %}
                            <div class="form-text">{{ form.crear_template.help_text }}</div>
                        {% endif %}
                        {% if form.crear_template.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.crear_template.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-warning alert-sm mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Nota:</strong> El template se crear√° con los campos que agregues abajo. Una vez guardado, estar√° disponible para futuros medios de pago.
                    </div>
                </div>
            {% endif %}

            <hr class="my-4">

            <!-- Campos din√°micos -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                    <i class="fas fa-list me-2"></i>Campos Espec√≠ficos
                </h4>
                <button type="button" id="add-campo" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-plus me-1"></i>
                    Agregar Campo
                </button>
            </div>

            <div id="campos-formset-container">
                {{ campos_formset.management_form }}
                
                {% if campos_formset.non_form_errors %}
                    <div class="alert alert-danger" role="alert">
                        {{ campos_formset.non_form_errors }}
                    </div>
                {% endif %}
                
                {% for form_campo in campos_formset %}
                    <div class="card mb-3 form-campo campo-predefinido {% if form_campo.DELETE.value %}d-none{% endif %}" 
                         data-campo-id="{{ form_campo.instance.pk|default:'' }}">
                        
                        {% if form_campo.instance.campo_api %}
                            <span class="badge bg-primary">Predefinido</span>
                        {% else %}
                            <span class="badge bg-success">Nuevo</span>
                        {% endif %}
                        
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="card-title mb-0">
                                    Campo #<span class="field-number">{{ forloop.counter }}</span>
                                </h6>
                                
                                <div class="d-flex align-items-center gap-2">
                                    {% if form_campo.instance.pk %}
                                        <small class="text-muted">Existente</small>
                                    {% else %}
                                        <small class="text-success">Nuevo</small>
                                    {% endif %}
                                    
                                    {% if form_campo.DELETE and is_edit %}
                                        <div class="form-check m-0">
                                            {{ form_campo.DELETE }}
                                            <label class="form-check-label text-danger" for="{{ form_campo.DELETE.id_for_label }}">
                                                <i class="fas fa-trash"></i> Eliminar
                                            </label>
                                        </div>
                                    {% endif %}
                                    
                                    {% if not is_edit %}
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-campo-btn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {{ form_campo.id }}
                            
                            {% if form_campo.non_field_errors %}
                                <div class="alert alert-danger alert-sm">
                                    {{ form_campo.non_field_errors }}
                                </div>
                            {% endif %}

                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="{{ form_campo.campo_api.id_for_label }}" class="form-label">
                                            <i class="fas fa-cog me-1"></i>Campo Predefinido
                                        </label>
                                        {{ form_campo.campo_api }}
                                        {% if form_campo.campo_api.errors %}
                                            <div class="text-danger small mt-1">
                                                {{ form_campo.campo_api.errors }}
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Informaci√≥n del campo seleccionado -->
                                        <div class="field-info field-info-hidden mt-2" id="field-info-{{ forloop.counter0 }}">
                                            <div class="row">
                                                <div class="col-6">
                                                    <strong>Nombre:</strong> <span class="field-name">-</span>
                                                </div>
                                                <div class="col-6">
                                                    <strong>Tipo:</strong> <span class="field-type">-</span>
                                                </div>
                                                <div class="col-12 mt-1">
                                                    <small class="text-muted field-description">-</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-asterisk me-1 text-danger"></i>¬øEs requerido?
                                        </label>
                                        <div class="form-check">
                                            {{ form_campo.is_required }}
                                            <label class="form-check-label" for="{{ form_campo.is_required.id_for_label }}">
                                                Campo obligatorio
                                            </label>
                                        </div>
                                        {% if form_campo.is_required.errors %}
                                            <div class="text-danger small">
                                                {{ form_campo.is_required.errors }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="alert alert-info text-center no-fields-message" id="no-fields-message">
                        <i class="fas fa-info-circle me-2"></i>
                        {% if is_edit %}
                            Este medio de pago no tiene campos espec√≠ficos definidos.
                        {% else %}
                            No hay campos definidos a√∫n. Selecciona un template arriba o agrega campos manualmente.
                        {% endif %}
                    </div>
                {% endfor %}
                
                <!-- Template para nuevos campos -->
                <div id="empty-form-template" class="card mb-3 form-campo campo-predefinido d-none">
                    <span class="badge bg-success">Nuevo</span>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title mb-0">Campo #<span class="field-number"></span></h6>
                            <div class="d-flex align-items-center gap-2">
                                <small class="text-success">Nuevo</small>
                                {% if is_edit %}
                                    <div class="form-check m-0">
                                        {{ campos_formset.empty_form.DELETE }}
                                        <label class="form-check-label text-danger">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </label>
                                    </div>
                                {% else %}
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-campo-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        {{ campos_formset.empty_form.id }}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-cog me-1"></i>Campo Predefinido
                                    </label>
                                    {{ campos_formset.empty_form.campo_api }}
                                    
                                    <!-- Informaci√≥n del campo -->
                                    <div class="field-info field-info-hidden mt-2" id="field-info-__prefix__">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Nombre:</strong> <span class="field-name">-</span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Tipo:</strong> <span class="field-type">-</span>
                                            </div>
                                            <div class="col-12 mt-1">
                                                <small class="text-muted field-description">-</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-asterisk me-1 text-danger"></i>¬øEs requerido?
                                    </label>
                                    <div class="form-check">
                                        {{ campos_formset.empty_form.is_required }}
                                        <label class="form-check-label">Campo obligatorio</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-save me-2"></i>Guardar Medio de Pago
                </button>
                <a href="{% url 'medios_pago:lista' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver a la Lista
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Datos JavaScript para campos predefinidos - ACTUALIZADO -->
<script id="predefined-fields-data" type="application/json">
{
    "card_number": {"label": "N√∫mero de tarjeta", "type": "NUMERO", "description": "N√∫mero de 16 d√≠gitos de la tarjeta", "required": true},
    "exp_month": {"label": "Mes de vencimiento", "type": "NUMERO", "description": "Mes de vencimiento (1-12)", "required": true},
    "exp_year": {"label": "A√±o de vencimiento", "type": "NUMERO", "description": "A√±o de vencimiento (4 d√≠gitos)", "required": true},
    "cvc": {"label": "C√≥digo de seguridad", "type": "NUMERO", "description": "C√≥digo CVV/CVC de 3 o 4 d√≠gitos", "required": true},
    "cardholder_name": {"label": "Nombre en la tarjeta", "type": "TEXTO", "description": "Nombre como aparece en la tarjeta", "required": true},
    "paypal_email": {"label": "Email de PayPal", "type": "EMAIL", "description": "Direcci√≥n de email asociada a PayPal", "required": true},
    "account_number": {"label": "N√∫mero de cuenta", "type": "NUMERO", "description": "N√∫mero de cuenta bancaria", "required": true},
    "bank_name": {"label": "Entidad", "type": "TEXTO", "description": "Nombre de la entidad financiera (banco, billetera, etc.)", "required": true},
    "account_holder": {"label": "Titular de la cuenta", "type": "TEXTO", "description": "Nombre del titular de la cuenta", "required": true},
    "routing_number": {"label": "C√≥digo de routing", "type": "NUMERO", "description": "C√≥digo de routing bancario (USA)", "required": false},
    "swift_code": {"label": "C√≥digo SWIFT", "type": "TEXTO", "description": "C√≥digo SWIFT para transferencias internacionales", "required": false},
    "cbu_cvu": {"label": "CBU/CVU", "type": "NUMERO", "description": "Clave Bancaria Uniforme o Clave Virtual Uniforme", "required": true},
    "ruc": {"label": "RUC", "type": "NUMERO", "description": "Registro √önico del Contribuyente", "required": false},
    "email": {"label": "Email", "type": "EMAIL", "description": "Direcci√≥n de correo electr√≥nico", "required": true},
    "phone": {"label": "Tel√©fono", "type": "TELEFONO", "description": "N√∫mero de tel√©fono", "required": false},
    "description": {"label": "Descripci√≥n", "type": "TEXTO", "description": "Descripci√≥n del medio de pago", "required": false},
    "wallet_address": {"label": "Direcci√≥n de billetera", "type": "TEXTO", "description": "Direcci√≥n de billetera de criptomoneda", "required": true},
    "network": {"label": "Red", "type": "TEXTO", "description": "Red blockchain (ETH, BTC, etc.)", "required": true},
    "wallet_phone": {"label": "Tel√©fono de billetera", "type": "TELEFONO", "description": "N√∫mero de tel√©fono asociado a la billetera", "required": true},
    "wallet_email": {"label": "Email de billetera", "type": "EMAIL", "description": "Email asociado a la billetera electr√≥nica", "required": false},
    "wallet_user_id": {"label": "ID de usuario", "type": "TEXTO", "description": "Identificador de usuario en la billetera", "required": false},
    "document_number": {"label": "N√∫mero de documento", "type": "NUMERO", "description": "N√∫mero de c√©dula o documento de identidad", "required": false}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Iniciando sistema de templates din√°micos...');
    
    // Cargar datos de campos predefinidos
    const predefinedFields = JSON.parse(document.getElementById('predefined-fields-data').textContent);
    console.log('üìã Campos predefinidos cargados:', Object.keys(predefinedFields).length);
    
    // Templates predefinidos ACTUALIZADOS (disponibles inmediatamente)
    let allTemplates = {
        "stripe_card": {
            "name": "Tarjeta de Cr√©dito/D√©bito (Stripe)", 
            "fields": ["card_number", "exp_month", "exp_year", "cvc", "cardholder_name", "email"], 
            "is_custom": false
        },
        "paypal_standard": {
            "name": "PayPal Est√°ndar", 
            "fields": ["paypal_email", "description"], 
            "is_custom": false
        },
        "bank_local_ar": {
            "name": "Transferencia Bancaria local",
            "fields": ["account_number", "bank_name", "account_holder", "cbu_cvu", "ruc"],
            "is_custom": false
        },
        "bank_international": {
            "name": "Transferencia Bancaria Internacional", 
            "fields": ["account_number", "bank_name", "account_holder", "swift_code", "routing_number"], 
            "is_custom": false
        },
        "bitcoin_wallet": {
            "name": "Billetera Bitcoin", 
            "fields": ["wallet_address", "network"], 
            "is_custom": false
        },
        "billetera_electronica_py": {
            "name": "Billetera Electr√≥nica Paraguay", 
            "fields": ["wallet_phone", "bank_name", "account_holder", "document_number", "wallet_email"], 
            "is_custom": false
        },
        "efectivo_simple": {
            "name": "Pago en Efectivo", 
            "fields": ["description"], 
            "is_custom": false
        }
    };
    
    // Referencias DOM - buscar por m√∫ltiples m√©todos
    const addButton = document.getElementById('add-campo');
    const container = document.getElementById('campos-formset-container');
    const managementForm = document.querySelector('input[name$="TOTAL_FORMS"]');
    const emptyFormTemplate = document.getElementById('empty-form-template');
    const noFieldsMessage = document.getElementById('no-fields-message');
    const templateCreator = document.getElementById('template-creator');
    const toggleTemplateCreatorBtn = document.getElementById('toggle-template-creator');
    
    // Buscar template selector por m√∫ltiples m√©todos
    let templateSelector = document.getElementById('id_aplicar_template') ||
                          document.querySelector('select[name="aplicar_template"]') ||
                          document.querySelector('[name*="aplicar_template"]') ||
                          document.querySelector('.template-selector select');
    
    console.log('üéØ Referencias DOM:', {
        addButton: !!addButton,
        container: !!container,
        managementForm: !!managementForm,
        emptyFormTemplate: !!emptyFormTemplate,
        templateSelector: !!templateSelector,
        noFieldsMessage: !!noFieldsMessage,
        templateCreator: !!templateCreator,
        toggleTemplateCreatorBtn: !!toggleTemplateCreatorBtn
    });
    
    // Debugging del template selector
    if (!templateSelector) {
        console.error('‚ùå Template selector no encontrado!');
        console.log('üîç Selectores disponibles:');
        document.querySelectorAll('select').forEach((select, index) => {
            console.log(`   Select ${index}:`, {
                id: select.id,
                name: select.name,
                className: select.className
            });
        });
    } else {
        console.log('‚úÖ Template selector encontrado:', {
            id: templateSelector.id,
            name: templateSelector.name,
            opciones: templateSelector.options.length
        });
    }
    
    const isEdit = "{{ is_edit|yesno:'true,false' }}" === "true";

    // Funci√≥n para actualizar informaci√≥n de campo
    function updateFieldInfo(selectElement) {
        if (!selectElement) return;
        
        const selectedValue = selectElement.value;
        const fieldInfoDiv = selectElement.closest('.form-campo')?.querySelector('.field-info');
        
        if (!fieldInfoDiv) return;
        
        if (selectedValue && predefinedFields[selectedValue]) {
            const fieldData = predefinedFields[selectedValue];
            
            fieldInfoDiv.querySelector('.field-name').textContent = fieldData.label || '-';
            fieldInfoDiv.querySelector('.field-type').textContent = fieldData.type || '-';
            fieldInfoDiv.querySelector('.field-description').textContent = fieldData.description || '-';
            
            fieldInfoDiv.classList.remove('field-info-hidden');
            console.log('‚ÑπÔ∏è Campo actualizado:', selectedValue, fieldData.label);
        } else {
            fieldInfoDiv.classList.add('field-info-hidden');
        }
    }

    // Funci√≥n para actualizar numeraci√≥n
    function updateFieldNumbers() {
        const campos = container.querySelectorAll('.form-campo:not(#empty-form-template):not(.marked-for-deletion):not(.d-none)');
        campos.forEach((campo, index) => {
            const numberSpan = campo.querySelector('.field-number');
            if (numberSpan) {
                numberSpan.textContent = index + 1;
            }
        });
        console.log('üî¢ Numeraci√≥n actualizada:', campos.length, 'campos');
    }

    // Funci√≥n para limpiar campos existentes
    function clearExistingFields() {
        console.log('üßπ Limpiando campos existentes...');
        const existingCampos = container.querySelectorAll('.form-campo:not(#empty-form-template)');
        existingCampos.forEach(campo => campo.remove());
        
        // Ocultar mensaje de "no hay campos"
        if (noFieldsMessage) {
            noFieldsMessage.style.display = 'none';
        }
        console.log('üóëÔ∏è Eliminados:', existingCampos.length, 'campos');
    }

    // Funci√≥n para agregar campo desde template
    function addCampoFromTemplate(fieldKey, formIndex) {
        console.log('‚ûï Agregando campo:', fieldKey, 'en √≠ndice:', formIndex);
        
        if (!predefinedFields[fieldKey]) {
            console.error('‚ùå Campo no existe en predefinedFields:', fieldKey);
            return;
        }
        
        const fieldData = predefinedFields[fieldKey];
        let newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formIndex);
        
        const newDiv = document.createElement('div');
        newDiv.className = 'card mb-3 form-campo campo-predefinido';
        newDiv.innerHTML = newFormHtml;
        
        // Configurar el select con el valor correcto
        const select = newDiv.querySelector('select[name*="campo_api"]');
        if (select) {
            select.value = fieldKey;
            console.log('‚úÖ Campo seleccionado:', fieldKey);
        }
        
        // Configurar checkbox de required
        const requiredCheckbox = newDiv.querySelector('input[name*="is_required"]');
        if (requiredCheckbox && fieldData.required !== undefined) {
            requiredCheckbox.checked = fieldData.required;
        }
        
        // Actualizar informaci√≥n del campo
        updateFieldInfo(select);
        
        // Insertar en el container
        container.insertBefore(newDiv, emptyFormTemplate);
        console.log('‚úÖ Campo agregado exitosamente');
    }

    // APLICAR TEMPLATE - Funci√≥n principal
    function initializeTemplateSelector() {
        if (!templateSelector) {
            console.warn('‚ö†Ô∏è Template selector no disponible');
            return;
        }
        
        console.log('üé® Configurando evento de template selector...');
        
        templateSelector.addEventListener('change', async function() {
            const selectedValue = this.value;
            console.log('üéØ Template seleccionado:', selectedValue);
            
            if (!selectedValue) {
                console.log('‚≠ï Valor vac√≠o, no hacer nada');
                return;
            }
            
            let template = allTemplates[selectedValue];
            
            // Si es template personalizado, cargar campos din√°micamente
            if (template && template.is_custom && (!template.fields || template.fields.length === 0)) {
                console.log('üî• Cargando template personalizado:', selectedValue);
                try {
                    const url = `{% url "medios_pago:template_data" "TEMPLATE_KEY" %}`.replace('TEMPLATE_KEY', selectedValue);
                    console.log('üåê Fetching:', url);
                    
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.fields) {
                            template.fields = data.fields;
                            console.log('‚úÖ Template personalizado cargado:', data.fields);
                        } else {
                            console.error('‚ùå Respuesta inv√°lida:', data);
                        }
                    } else {
                        console.error('‚ùå Error HTTP:', response.status);
                    }
                } catch (error) {
                    console.error('‚ùå Error cargando template personalizado:', error);
                    alert('Error cargando el template personalizado: ' + error.message);
                    this.value = '';
                    return;
                }
            }
            
            if (!template || !template.fields) {
                console.error('‚ùå Template no v√°lido:', selectedValue, template);
                return;
            }
            
            // Limpiar campos existentes
            clearExistingFields();
            
            console.log('üìù Agregando campos del template:', template.fields);
            
            // Agregar campos del template
            let totalForms = 0;
            template.fields.forEach((fieldKey, index) => {
                console.log(`‚ûï Procesando campo ${index + 1}/${template.fields.length}:`, fieldKey);
                if (predefinedFields[fieldKey]) {
                    addCampoFromTemplate(fieldKey, totalForms);
                    totalForms++;
                } else {
                    console.warn('‚ö†Ô∏è Campo no encontrado en predefinedFields:', fieldKey);
                }
            });
            
            // Actualizar management form
            if (managementForm) {
                managementForm.value = totalForms;
                console.log('üìä Management form actualizado:', totalForms);
            }
            
            updateFieldNumbers();
            
            // Mostrar mensaje de √©xito
            showTemplateMessage(`Template "${template.name.replace(' üé®', '')}" aplicado. ${totalForms} campos agregados.`);
        });
    }

    // Mostrar mensaje de template aplicado
    function showTemplateMessage(message) {
        console.log('üí¨ Mostrando mensaje:', message);
        if (!templateSelector) return;
        
        const successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success alert-dismissible fade show mt-3';
        successAlert.innerHTML = `
            <i class="fas fa-check me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        templateSelector.closest('.template-selector').appendChild(successAlert);
        
        // Auto-hide alert
        setTimeout(() => {
            if (successAlert.parentNode) {
                successAlert.remove();
            }
        }, 5000);
    }

    // Toggle para mostrar/ocultar creador de templates
    if (toggleTemplateCreatorBtn && templateCreator) {
        toggleTemplateCreatorBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (templateCreator.style.display === 'none' || !templateCreator.style.display) {
                // Mostrar
                templateCreator.style.display = 'block';
                templateCreator.classList.add('show');
                this.innerHTML = '<i class="fas fa-times-circle me-1"></i>Cancelar Template';
                this.className = 'btn btn-outline-secondary btn-sm';
                
                // Focus en el input
                const inputField = templateCreator.querySelector('input[type="text"]');
                if (inputField) {
                    setTimeout(() => inputField.focus(), 100);
                }
                
                console.log('üìù Secci√≥n de crear template mostrada');
            } else {
                // Ocultar
                templateCreator.style.display = 'none';
                templateCreator.classList.remove('show');
                this.innerHTML = '<i class="fas fa-plus-circle me-1"></i>Crear Template Personalizado';
                this.className = 'btn btn-warning btn-sm';
                
                // Limpiar el campo
                const inputField = templateCreator.querySelector('input[type="text"]');
                if (inputField) {
                    inputField.value = '';
                }
                
                console.log('‚ùå Secci√≥n de crear template ocultada');
            }
        });
    }

    // Agregar campo manual
    if (addButton && emptyFormTemplate && managementForm) {
        addButton.addEventListener('click', function() {
            console.log('‚ûï Agregando campo manual...');
            
            // Ocultar mensaje de "no hay campos" si est√° visible
            if (noFieldsMessage) {
                noFieldsMessage.style.display = 'none';
            }
            
            const totalForms = parseInt(managementForm.value) || 0;
            let newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, totalForms);
            
            const newDiv = document.createElement('div');
            newDiv.className = 'card mb-3 form-campo campo-predefinido';
            newDiv.innerHTML = newFormHtml;
            
            // Insertar antes del template
            container.insertBefore(newDiv, emptyFormTemplate);
            managementForm.value = totalForms + 1;
            
            updateFieldNumbers();
            console.log('‚úÖ Campo manual agregado');
        });
    }

    // Manejar eliminaci√≥n de campos (para creaci√≥n)
    document.body.addEventListener('click', function(e) {
        if (e.target.matches('.remove-campo-btn, .remove-campo-btn *')) {
            const button = e.target.closest('.remove-campo-btn');
            if (button) {
                const formDiv = button.closest('.form-campo');
                if (formDiv && !formDiv.id.includes('empty-form-template')) {
                    formDiv.remove();
                    
                    // Actualizar management form
                    if (managementForm) {
                        const currentTotal = parseInt(managementForm.value) || 0;
                        managementForm.value = Math.max(0, currentTotal - 1);
                    }
                    
                    updateFieldNumbers();
                    
                    // Mostrar mensaje si no hay campos
                    const remainingCampos = container.querySelectorAll('.form-campo:not(#empty-form-template)');
                    if (remainingCampos.length === 0 && noFieldsMessage) {
                        noFieldsMessage.style.display = 'block';
                    }
                    
                    console.log('üóëÔ∏è Campo eliminado');
                }
            }
        }
    });

    // Manejar cambios en selectores de campo
    document.body.addEventListener('change', function(e) {
        if (e.target.matches('select[name*="campo_api"]')) {
            console.log('üîÑ Campo API cambiado:', e.target.value);
            updateFieldInfo(e.target);
        }
        
        // Manejar marcado para eliminaci√≥n (solo en edici√≥n)
        if (e.target && e.target.name && e.target.name.indexOf('DELETE') > -1) {
            const formDiv = e.target.closest('.form-campo');
            if (formDiv) {
                if (e.target.checked) {
                    formDiv.classList.add('marked-for-deletion');
                    console.log('üóëÔ∏è Campo marcado para eliminaci√≥n');
                } else {
                    formDiv.classList.remove('marked-for-deletion');
                    console.log('‚Ü©Ô∏è Marca de eliminaci√≥n removida');
                }
                updateFieldNumbers();
            }
        }
    });

    // Cargar templates personalizados (no bloqueante)
    async function loadCustomTemplates() {
        console.log('üî• Cargando templates personalizados...');
        try {
            const response = await fetch('{% url "medios_pago:template_list" %}');
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.templates) {
                    console.log('üì¶ Templates personalizados encontrados:', data.templates.length);
                    
                    // Agregar templates personalizados
                    data.templates.forEach(template => {
                        if (template.is_custom) {
                            allTemplates[template.key] = {
                                name: template.name + ' üé®',
                                fields: [], // Se cargar√°n cuando se necesiten
                                is_custom: true
                            };
                            console.log('‚ûï Template personalizado agregado:', template.key);
                        }
                    });
                    
                    // Actualizar opciones del selector
                    if (templateSelector) {
                        updateTemplateOptions();
                    }
                }
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Error cargando templates personalizados:', error);
        }
    }

    function updateTemplateOptions() {
        if (!templateSelector) return;
        
        console.log('üîÑ Actualizando opciones del selector...');
        
        // Guardar valor actual
        const currentValue = templateSelector.value;
        
        // Limpiar opciones manteniendo la primera
        const firstOption = templateSelector.querySelector('option[value=""]');
        templateSelector.innerHTML = '';
        
        // Agregar opci√≥n vac√≠a
        if (firstOption) {
            templateSelector.appendChild(firstOption);
        } else {
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '--- Personalizado ---';
            templateSelector.appendChild(emptyOption);
        }
        
        // Agregar templates
        Object.entries(allTemplates).forEach(([key, template]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = template.name;
            templateSelector.appendChild(option);
        });
        
        // Restaurar valor
        if (currentValue && allTemplates[currentValue]) {
            templateSelector.value = currentValue;
        }
        
        console.log('‚úÖ Opciones actualizadas:', Object.keys(allTemplates).length, 'templates disponibles');
    }
    
    // Inicializar sistema
    console.log('üöÄ Inicializando sistema...');
    
    // Configurar template selector
    initializeTemplateSelector();
    
    // Inicializar campos existentes
    document.querySelectorAll('select[name*="campo_api"]').forEach(select => {
        updateFieldInfo(select);
    });
    
    updateFieldNumbers();
    
    // Cargar templates personalizados al final (no bloquea la UI)
    loadCustomTemplates();
    
});
</script>
{% endblock %}