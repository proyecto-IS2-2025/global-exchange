<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white text-center rounded-top-4">
                    <h4 class="mb-0"><i class="bi bi-cash-coin me-2"></i> Simulador de Divisas</h4>
                    {% if user.is_authenticated %}
                    <small>Conectado como: {{ user.username }} - Segmento: {{ segmento_usuario }}</small>
                    {% endif %}
                </div>
                <div class="card-body bg-light">
                    <form id="simulador-form" class="needs-validation" novalidate>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="tipoOperacion" required>
                                        <option value="compra">Quiero comprar</option>
                                        <option value="venta">Quiero vender</option>
                                    </select>
                                    <label for="tipoOperacion"><i class="bi bi-arrows-exchange me-2 text-primary"></i> Tipo de operación</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="moneda" required>
                                        {% for d in divisas_list %}
                                            {% if d.code != 'PYG' %}  <!-- Excluir Guaraní por código -->
                                            <option value="{{ d.code }}">{{ d.nombre }} ({{ d.simbolo }})</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                    <label for="moneda"><i class="bi bi-currency-exchange me-2 text-primary"></i> Seleccionar divisa</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="number" class="form-control" id="monto" placeholder="Ingrese el monto" step="0.01" min="0" required>
                            <label id="monto-label" for="monto"><i class="bi bi-123 me-2 text-primary"></i> Ingrese el monto</label>
                        </div>

                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill">
                                <i class="bi bi-calculator me-2"></i>Calcular
                            </button>
                        </div>
                    </form>

                    <div id="resultado-box" class="alert d-none mt-4"></div>
                    <div id="loading" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Calculando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('simulador-form');
        const resultadoBox = document.getElementById('resultado-box');
        const loading = document.getElementById('loading');
        const tipoOperacionSelect = document.getElementById('tipoOperacion');
        const montoInput = document.getElementById('monto');
        const montoLabel = document.getElementById('monto-label');
        const monedaSelect = document.getElementById('moneda');

        function actualizarPlaceholder() {
            const tipo = tipoOperacionSelect.value;
            const monedaOption = monedaSelect.options[monedaSelect.selectedIndex];
            const monedaSimbolo = monedaOption.text.match(/\(([^)]+)\)/)[1];
            
            if (tipo === 'compra') {
                montoLabel.innerHTML = '<i class="bi bi-123 me-2 text-primary"></i> Ingrese el monto en Gs.';
                montoInput.placeholder = 'Ej: 100000';
            } else {
                montoLabel.innerHTML = `<i class="bi bi-123 me-2 text-primary"></i> Ingrese el monto en ${monedaSimbolo}`;
                montoInput.placeholder = `Ej: 100`;
            }
        }
        
        // Inicializar
        actualizarPlaceholder();
        tipoOperacionSelect.addEventListener('change', actualizarPlaceholder);
        monedaSelect.addEventListener('change', actualizarPlaceholder);

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            resultadoBox.classList.add('d-none');
            resultadoBox.classList.remove('alert-success', 'alert-danger');
            loading.classList.remove('d-none');

            const tipoOperacion = tipoOperacionSelect.value;
            const monto = parseFloat(montoInput.value);
            const moneda = monedaSelect.value;

            // Validación adicional para Guaraní (código PYG)
            if (moneda === 'PYG') {
                resultadoBox.classList.add('alert-danger');
                resultadoBox.innerHTML = 'No se permiten operaciones con Guaraní (PYG) en el simulador.';
                resultadoBox.classList.remove('d-none');
                loading.classList.add('d-none');
                return;
            }

            if (isNaN(monto) || monto <= 0) {
                resultadoBox.classList.add('alert-danger');
                resultadoBox.innerHTML = "Por favor, ingrese un monto válido mayor a cero.";
                resultadoBox.classList.remove("d-none");
                loading.classList.add('d-none');
                return;
            }

            const payload = {
                tipo_operacion: tipoOperacion,
                monto: monto,
                moneda: moneda
            };
            
            try {
                const response = await fetch('{% url "simulador:calcular_simulacion_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const resultado = parseFloat(data.monto_resultado).toLocaleString('es-PY', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: data.moneda_code === 'PYG' ? 2 : 8 
                    });
                    
                    const tasa_aplicada = parseFloat(data.tasa_aplicada).toLocaleString('es-PY', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 8 
                    });
                    
                    const comision_aplicada = parseFloat(data.comision_aplicada).toLocaleString('es-PY', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 8 
                    });
                    
                    const porcentaje_descuento = parseFloat(data.porcentaje_descuento).toLocaleString('es-PY', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    const segmento = data.segmento.toUpperCase();

                    let resultadoFinalHtml = '';
                    if (tipoOperacion === 'compra') {
                        resultadoFinalHtml = `
                            <h5 class="alert-heading">Resultado de la operación</h5>
                            <div class="text-start">
                                <div><strong>Segmento:</strong> ${segmento}</div>
                                <div><strong>Descuento aplicado:</strong> ${porcentaje_descuento}%</div>
                                <div><strong>Comisión aplicada:</strong> ${comision_aplicada} ${data.moneda_simbolo}</div>
                                <div><strong>Tasa aplicada:</strong> ${tasa_aplicada} PYG/${data.moneda_simbolo}</div>
                                <hr>
                                <div class="fw-bold fs-5">Recibirás: ${resultado} ${data.moneda_simbolo}</div>
                                <div class="small text-muted">Por ${data.monto_original} PYG</div>
                            </div>
                        `;
                    } else {
                        resultadoFinalHtml = `
                            <h5 class="alert-heading">Resultado de la operación</h5>
                            <div class="text-start">
                                <div><strong>Segmento:</strong> ${segmento}</div>
                                <div><strong>Descuento aplicado:</strong> ${porcentaje_descuento}%</div>
                                <div><strong>Comisión aplicada:</strong> ${comision_aplicada} ${data.moneda_simbolo}</div>
                                <div><strong>Tasa aplicada:</strong> ${tasa_aplicada} PYG/${data.moneda_simbolo}</div>
                                <hr>
                                <div class="fw-bold fs-5">Recibirás: ${resultado} PYG</div>
                                <div class="small text-muted">Por ${data.monto_original} ${data.moneda_simbolo}</div>
                            </div>
                        `;
                    }

                    resultadoBox.classList.add('alert-success');
                    resultadoBox.innerHTML = resultadoFinalHtml;
                    resultadoBox.classList.remove("d-none");
                } else {
                    resultadoBox.classList.add('alert-danger');
                    resultadoBox.innerHTML = `<strong>Error:</strong> ${data.error}`;
                    resultadoBox.classList.remove("d-none");
                }

            } catch (error) {
                console.error("Error en la solicitud:", error);
                resultadoBox.classList.add('alert-danger');
                resultadoBox.innerHTML = "<strong>Error:</strong> Ocurrió un error al procesar la solicitud.";
                resultadoBox.classList.remove("d-none");
            } finally {
                loading.classList.add('d-none');
            }
        });
    });
</script>