<!-- clientes/templates/clientes/medios_pago/form_medio_pago.html -->
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="card bg-primary text-white mb-4">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">{{ action }} Medio de Pago</h4>
                        <small>{{ medio_de_pago.nombre }} - {{ cliente.nombre_completo }}</small>
                    </div>
                    <div>
                        <span class="badge bg-warning text-dark">{{ medio_de_pago.comision_porcentaje }}%</span>
                    </div>
                </div>
            </div>

            <!-- DEBUG: Información del formulario -->
            <div class="alert alert-info">
                <strong>DEBUG:</strong> 
                Medio de Pago ID: {{ form.medio_de_pago.value|default:"No definido" }}<br>
                Initial: {{ form.medio_de_pago.field.initial|default:"No definido" }}<br>
                Object: {{ medio_de_pago.id }}<br>
                Form fields: {{ form.fields.keys }}<br>
                Campos esperados: {% for campo in campos %}campo_{{ campo.id }}{% if not forloop.last %}, {% endif %}{% endfor %}
            </div>

            <!-- Mostrar todos los errores del formulario -->
            {% if form.errors %}
                <div class="alert alert-danger">
                    <h5>Errores en el formulario:</h5>
                    {{ form.errors }}
                    {% for field_name, field_errors in form.errors.items %}
                        <strong>{{ field_name }}:</strong> 
                        {% for error in field_errors %}
                            {{ error }}<br>
                        {% endfor %}
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Formulario -->
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <!-- Campo hidden para medio_de_pago - FORZAR VALOR -->
                <input type="hidden" name="medio_de_pago" value="{{ medio_de_pago.id }}" id="id_medio_de_pago">
                
                <div class="row">
                    <!-- Información del Cliente -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Cliente</h5>
                            </div>
                            <div class="card-body">
                                <input type="text" class="form-control" value="{{ cliente.nombre_completo }}" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Información del Medio de Pago -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Medio de Pago</h5>
                            </div>
                            <div class="card-body">
                                <input type="text" class="form-control" value="{{ medio_de_pago.nombre }}" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campo es_principal -->
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="form-check">
                            {{ form.es_principal }}
                            <label class="form-check-label" for="{{ form.es_principal.id_for_label }}">
                                {{ form.es_principal.label }}
                            </label>
                            <div class="form-text">{{ form.es_principal.help_text }}</div>
                            {% if form.es_principal.errors %}
                                <div class="text-danger">{{ form.es_principal.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Campos Dinámicos - NUEVO MÉTODO DIRECTO -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Datos del Medio de Pago</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Renderizar TODOS los campos que empiecen con 'campo_' -->
                            {% for field in form %}
                                {% if field.name|slice:":6" == "campo_" %}
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ field.id_for_label }}" class="form-label">
                                            {{ field.label }}
                                            {% if field.field.required %}
                                                <span class="text-danger">*</span>
                                            {% endif %}
                                        </label>
                                        {{ field }}
                                        
                                        {% if field.help_text %}
                                            <div class="form-text">{{ field.help_text }}</div>
                                        {% endif %}
                                        
                                        {% if field.errors %}
                                            <div class="text-danger">
                                                {% for error in field.errors %}
                                                    <small>{{ error }}</small><br>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                            
                            <!-- DEBUG: Mostrar información de campos dinámicos encontrados -->
                            <div class="col-12">
                                <div class="alert alert-secondary">
                                    <strong>DEBUG Campos encontrados:</strong><br>
                                    {% for field in form %}
                                        {% if field.name|slice:":6" == "campo_" %}
                                            - {{ field.name }}: {{ field.label }}<br>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Errores generales del formulario -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger mt-3">
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Botones -->
                <div class="d-flex justify-content-end mt-4">
                    <a href="{% url 'clientes:medios_pago_cliente' %}" class="btn btn-secondary me-2">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Debug y verificación del campo hidden
    console.log('=== DEBUG TEMPLATE ===');
    console.log('Medio de Pago ID:', '{{ medio_de_pago.id }}');
    
    const medioField = document.querySelector('input[name="medio_de_pago"]');
    console.log('Campo medio_de_pago encontrado:', medioField);
    console.log('Valor del campo:', medioField ? medioField.value : 'Campo no encontrado');
    
    // Asegurar que el campo tenga el valor correcto
    if (medioField) {
        medioField.value = '{{ medio_de_pago.id }}';
        console.log('Valor asignado:', medioField.value);
    }
    
    // Debug de todos los campos del formulario
    const allFields = document.querySelectorAll('input, select, textarea');
    console.log('Todos los campos del formulario:');
    allFields.forEach(field => {
        if (field.name.startsWith('campo_')) {
            console.log(`- CAMPO DINÁMICO ${field.name}: "${field.value}" (${field.type})`);
        } else {
            console.log(`- ${field.name}: "${field.value}"`);
        }
    });
    
    // Verificar que los campos dinámicos estén presentes
    const camposDinamicos = document.querySelectorAll('input[name^="campo_"]');
    console.log(`Total campos dinámicos encontrados: ${camposDinamicos.length}`);
});
</script>