{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-5 text-center text-uppercase fw-bold text-primary">
    <i class="bi bi-people-fill me-2"></i> Selecciona un Cliente
  </h2>

  {% if clientes_asignados %}
    <div class="row justify-content-center g-4">
      {% for cliente in clientes_asignados %}
        <div class="col-md-4 col-sm-6">
          <form method="post" class="h-100">
            {% csrf_token %}
            <input type="hidden" name="cliente_id" value="{{ cliente.id }}">

            <!-- tarjeta: --i para escalonar animación -->
            <div class="card cliente-card h-100 border-0 rounded-4 shadow-sm
                        {% if cliente.id == cliente_activo_id %} cliente-activo {% endif %}"
                 style="--i: {{ forloop.counter0 }};">

              <!-- Header -->
              <div class="card-header text-center fw-bold text-white rounded-top-4 gradient-header">
                <i class="bi bi-person-circle me-2 fs-4"></i> {{ cliente.nombre_completo }}
              </div>

              <!-- Body -->
              <div class="card-body text-center py-4">
                <p class="mb-1"><strong>Cédula:</strong> {{ cliente.cedula }}</p>

                <p class="text-muted mb-1">
                  <i class="bi bi-envelope me-1 text-primary"></i>
                  {{ cliente.email|default:"No registrado" }}
                </p>

                <p class="text-muted mb-1">
                  <i class="bi bi-telephone me-1 text-primary"></i>
                  {{ cliente.telefono|default:"No disponible" }}
                </p>

                <p class="text-muted mb-1">
                  <i class="bi bi-geo-alt me-1 text-primary"></i>
                  {{ cliente.direccion|default:"No registrada" }}
                </p>

                <div class="mt-3 small">
                  <span class="badge bg-info text-dark me-1">Segmento: {{ cliente.segmento.name }}</span>
                  <span class="badge bg-secondary">Tipo: {{ cliente.tipo_cliente|capfirst }}</span>
                </div>
              </div>

              <!-- Footer -->
<!-- Footer -->
<div class="card-footer text-center bg-light border-top rounded-bottom-4 py-3">
  {% if cliente.id == cliente_activo_id %}
    <span class="badge bg-success p-2 fs-6 cliente-badge-active" title="Cliente activo">
      <i class="bi bi-check-circle me-1"></i> Cliente Activo
    </span>
  {% else %}
    <span class="badge bg-primary p-2 fs-6 cliente-badge-select" title="Haz click para usar este cliente">
      <i class="bi bi-arrow-right-circle me-1"></i> Seleccionable
    </span>
  {% endif %}
</div>
            </div>
          </form>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning text-center rounded-4 shadow-sm py-4 px-3">
      <i class="bi bi-exclamation-triangle-fill text-warning fs-4 me-2"></i>
      <p class="mb-2">No tienes clientes asignados. Se usará el segmento <strong>General</strong>.</p>
      <a href="{% url 'divisas:visualizador_tasas' %}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-right-circle me-1"></i> Continuar
      </a>
    </div>
  {% endif %}
</div>

<!-- JS pequeño: hace la tarjeta clickeable. No dispara si es la tarjeta activa. -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.cliente-card').forEach(function(card){
    // no hacer nada si ya es la tarjeta activa
    if (card.classList.contains('cliente-activo')) return;

    // al click en la tarjeta, submit al form (salvo si se hizo click en un botón o enlace)
    card.addEventListener('click', function(ev){
      var trg = ev.target;
      if (trg.closest('button') || trg.closest('a') || trg.closest('input')) return;
      var form = card.closest('form');
      if (form) form.submit();
    });

    // accesibilidad: tecla Enter/Space cuando la tarjeta tiene focus
    card.setAttribute('tabindex','0');
    card.addEventListener('keydown', function(ev){
      if (ev.key === 'Enter' || ev.key === ' ') {
        ev.preventDefault();
        var form = card.closest('form');
        if (form) form.submit();
      }
    });
  });
});
</script>
{% endblock %}
