{% load static %}

<div class="container py-4">

  <!-- Bloque de Cliente Activo -->
  <div class="card shadow-sm border-0 rounded-4 mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        {% if request.user.is_authenticated %}
          {% if cliente_activo %}
            <h5 class="fw-bold mb-1">
              <i class="bi bi-person-circle text-primary me-2"></i>
              Cliente Activo: {{ cliente_activo.nombre_completo }}
            </h5>
            <p class="mb-0 text-muted">
              Segmento: <span class="badge bg-info text-dark">{{ cliente_activo.segmento.name }}</span>
            </p>
          {% else %}
            <h5 class="fw-bold mb-1">
              <i class="bi bi-people text-secondary me-2"></i>
              Usando Segmento General
            </h5>
          {% endif %}
        {% else %}
          <h5 class="fw-bold mb-1">
            <i class="bi bi-box-arrow-in-right text-secondary me-2"></i>
            No has iniciado sesión
          </h5>
        {% endif %}
      </div>

      <div>
        {% if request.user.is_authenticated %}
          {% if mostrar_alerta_sin_clientes %}
            <button class="btn btn-outline-secondary" disabled>
              <i class="bi bi-arrow-repeat me-1"></i> Cambiar Cliente
            </button>
          {% else %}
            <a href="{% url 'clientes:seleccionar_cliente' %}" class="btn btn-outline-primary">
              <i class="bi bi-arrow-repeat me-1"></i> Cambiar Cliente
            </a>
          {% endif %}
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-primary">
            <i class="bi bi-box-arrow-in-right me-1"></i> Iniciar Sesión
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  {% if mostrar_alerta_sin_clientes %}
    <div class="alert alert-warning text-center rounded-4 shadow-sm py-3 px-3 mb-4">
      <i class="bi bi-exclamation-triangle-fill text-warning fs-5 me-2"></i>
      No tienes clientes asignados. Se usará el segmento <strong>General</strong>.
    </div>
  {% endif %}

  <!-- Título del Visualizador -->
  <h2 class="mb-4 text-center">
    <i class="bi bi-currency-exchange me-2"></i>
    Tasas de Cambio | Segmento: <span class="text-primary">{{ segmento_activo.name }}</span>
  </h2>

  <!-- Tabla de Divisas -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle shadow-sm rounded-3 overflow-hidden">
      <thead class="table-dark text-center">
        <tr>
          <th scope="col">Divisa</th>
          <th scope="col">Código</th>
          <th scope="col">Segmento</th>
          <th scope="col">Compra</th>
          <th scope="col">Venta</th>
          <th scope="col">Descuento (%)</th>
          <th scope="col">Fecha</th>
        </tr>
      </thead>
      <tbody>
        {% for data in divisas_data %}
          {% if data.cotizaciones %}
            {% for cotizacion in data.cotizaciones %}
              <tr class="text-center">
                {% if forloop.first %}
                  <td class="fw-bold align-middle" rowspan="{{ data.cotizaciones|length }}">
                    {{ data.divisa.nombre }}
                  </td>
                  <td class="align-middle" rowspan="{{ data.cotizaciones|length }}">
                    <span class="badge bg-secondary">{{ data.divisa.code }}</span>
                  </td>
                {% endif %}

                <td>
                  <span class="badge bg-info text-dark">{{ cotizacion.segmento.name }}</span>
                </td>
                <td class="text-success fw-semibold">
                  {{ cotizacion.valor_compra_unit|floatformat:0 }}
                </td>
                <td class="text-primary fw-semibold">
                  {{ cotizacion.valor_venta_unit|floatformat:0 }}
                </td>
                <td class="text-warning fw-semibold">
                  {{ cotizacion.porcentaje_descuento|floatformat:2 }}%
                </td>
                <td class="text-muted small">
                  {{ cotizacion.fecha|date:"d/m/Y H:i" }}
                </td>
              </tr>
            {% endfor %}
          {% endif %}
        {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-3">
              <i class="bi bi-exclamation-triangle me-2"></i>
              No hay divisas activas con cotizaciones para tu segmento.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if divisas_data %}
    <div class="row mt-4">
      <div class="col-12">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Información:</strong>
          Las tasas mostradas corresponden únicamente a los segmentos de tus clientes asignados.
          Los valores de compra y venta ya incluyen el descuento correspondiente a cada segmento.
        </div>
      </div>
    </div>
  {% endif %}
</div>