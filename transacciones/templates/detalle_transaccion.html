{% extends "base.html" %}

{% block title %}Detalle de Transacción - {{ transaccion.numero_transaccion }}{% endblock %}

{% block extra_head %}
<style>
.transaction-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.info-card {
    transition: transform 0.2s ease-in-out;
}
.info-card:hover {
    transform: translateY(-2px);
}
.status-badge {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
}
.timeline-item {
    position: relative;
    padding-left: 2rem;
    margin-bottom: 1rem;
}
.timeline-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.5rem;
    width: 0.75rem;
    height: 0.75rem;
    background: #6c757d;
    border-radius: 50%;
    border: 2px solid white;
}
.timeline-item.timeline-active::before {
    background: #28a745;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Encabezado -->
    <div class="card mb-4 border-0 shadow">
        <div class="card-header bg-primary transaction-header text-white py-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3 class="mb-1">Transacción {{ transaccion.numero_transaccion }}</h3>
                    <p class="mb-0 opacity-75">{{ transaccion.get_tipo_operacion_display }} - {{ transaccion.cliente.nombre_completo }}</p>
                </div>
                <div class="col-md-4 text-md-end">
                    {% if transaccion.estado == 'pendiente' %}
                        <span class="badge bg-warning status-badge">{{ transaccion.get_estado_display }}</span>
                    {% elif transaccion.estado == 'pagada' %}
                        <span class="badge bg-success status-badge">{{ transaccion.get_estado_display }}</span>
                    {% elif transaccion.estado == 'cancelada' %}
                        <span class="badge bg-danger status-badge">{{ transaccion.get_estado_display }}</span>
                    {% elif transaccion.estado == 'anulada' %}
                        <span class="badge bg-dark status-badge">{{ transaccion.get_estado_display }}</span>
                    {% elif transaccion.estado == 'a_retirar' %}
                        <span class="badge bg-info status-badge">{{ transaccion.get_estado_display }}</span>
                    {% else %}
                        <span class="badge bg-secondary status-badge">{{ transaccion.get_estado_display }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna Principal -->
        <div class="col-lg-8">
            <!-- Información de la Operación -->
            <div class="card info-card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-currency-exchange me-2"></i>
                        Información de la Operación
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="text-muted small">Tipo de Operación</label>
                                <p class="mb-0 fw-bold text-capitalize">{{ transaccion.get_tipo_operacion_display }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Divisa Origen</label>
                                <p class="mb-0">
                                    <span class="badge bg-primary">{{ transaccion.divisa_origen.code }}</span>
                                    {{ transaccion.divisa_origen.name }}
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Monto Origen</label>
                                <p class="mb-0 fw-bold fs-5">{{ transaccion.monto_origen }} {{ transaccion.divisa_origen.code }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="text-muted small">Divisa Destino</label>
                                <p class="mb-0">
                                    <span class="badge bg-success">{{ transaccion.divisa_destino.code }}</span>
                                    {{ transaccion.divisa_destino.name }}
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Monto Destino</label>
                                <p class="mb-0 fw-bold fs-5 text-success">{{ transaccion.monto_destino }} {{ transaccion.divisa_destino.code }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Tasa de Cambio</label>
                                <p class="mb-0 fw-bold">{{ transaccion.tasa_de_cambio_aplicada }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información del Medio de Pago/Acreditación -->
            {% if transaccion.medio_pago_datos %}
            <div class="card info-card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-credit-card me-2"></i>
                        {% if transaccion.es_compra %}Medio de Pago{% else %}Medio de Acreditación{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="text-muted small">Nombre</label>
                                <p class="mb-0 fw-bold">{{ transaccion.medio_pago_datos.nombre|default:"No especificado" }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Tipo</label>
                                <p class="mb-0">{{ transaccion.medio_pago_datos.tipo|default:"No especificado" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="text-muted small">Comisión</label>
                                <p class="mb-0">{{ transaccion.medio_pago_datos.comision|default:"No aplica" }}</p>
                            </div>
                            {% if transaccion.medio_pago_datos.es_principal %}
                            <div class="mb-3">
                                <span class="badge bg-primary">
                                    <i class="bi bi-star-fill me-1"></i>Medio Principal
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Observaciones -->
            {% if transaccion.observaciones %}
            <div class="card info-card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-journal-text me-2"></i>
                        Observaciones
                    </h5>
                </div>
                <div class="card-body">
                    <div class="bg-light p-3 rounded">
                        {{ transaccion.observaciones|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Columna Lateral -->
        <div class="col-lg-4">
            <!-- Información General -->
            <div class="card info-card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Información General
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Fecha de Creación</label>
                        <p class="mb-0">{{ transaccion.fecha_creacion|date:"d/m/Y H:i:s" }}</p>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Última Actualización</label>
                        <p class="mb-0">{{ transaccion.fecha_actualizacion|date:"d/m/Y H:i:s" }}</p>
                    </div>
                    {% if transaccion.procesado_por %}
                    <div class="mb-3">
                        <label class="text-muted small">Procesado por</label>
                        <p class="mb-0">{{ transaccion.procesado_por.get_full_name|default:transaccion.procesado_por.username }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Acciones -->
            <div class="card info-card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-gear me-2"></i>
                        Acciones
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Acciones para el cliente -->
                    {% if not es_admin %}
                        {% if puede_cancelar %}
                        <a href="{% url 'transacciones:cancelar' numero_transaccion=transaccion.numero_transaccion %}" 
                           class="btn btn-outline-danger btn-sm w-100 mb-2">
                            <i class="bi bi-x-circle me-2"></i>Cancelar Transacción
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'transacciones:historial_cliente' %}" 
                           class="btn btn-outline-primary btn-sm w-100 mb-2">
                            <i class="bi bi-list me-2"></i>Ver Historial
                        </a>
                        
                        <a href="{% url 'inicio' %}" 
                           class="btn btn-primary btn-sm w-100">
                            <i class="bi bi-house me-2"></i>Volver al Inicio
                        </a>
                    {% endif %}

                    <!-- Acciones para admin -->
                    {% if es_admin %}
                        <form method="post" action="{% url 'transacciones:cambiar_estado' numero_transaccion=transaccion.numero_transaccion %}" 
                              class="mb-3" id="estadoForm">
                            {% csrf_token %}
                            <div class="mb-2">
                                <select name="nuevo_estado" class="form-select form-select-sm" required>
                                    <option value="">Cambiar estado...</option>
                                    {% for estado_value, estado_display in transaccion.ESTADO_CHOICES %}
                                        {% if estado_value != transaccion.estado %}
                                            <option value="{{ estado_value }}">{{ estado_display }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-2">
                                <textarea name="observaciones" class="form-control form-control-sm" 
                                          placeholder="Observaciones (opcional)" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-warning btn-sm w-100">
                                <i class="bi bi-arrow-repeat me-2"></i>Cambiar Estado
                            </button>
                        </form>
                        
                        <a href="{% url 'transacciones:historial_admin' %}" 
                           class="btn btn-outline-primary btn-sm w-100 mb-2">
                            <i class="bi bi-list me-2"></i>Historial Admin
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Cambios -->
    {% if historial %}
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Historial de Cambios
                    </h5>
                </div>
                <div class="card-body">
                    {% for cambio in historial %}
                    <div class="timeline-item {% if forloop.first %}timeline-active{% endif %}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    {% if cambio.estado_anterior %}
                                        {{ cambio.estado_anterior|capfirst }} → <strong>{{ cambio.estado_nuevo|capfirst }}</strong>
                                    {% else %}
                                        <strong>{{ cambio.estado_nuevo|capfirst }}</strong>
                                    {% endif %}
                                </h6>
                                <p class="mb-1 text-muted">{{ cambio.observaciones }}</p>
                                <small class="text-muted">
                                    {{ cambio.fecha_cambio|date:"d/m/Y H:i:s" }}
                                    {% if cambio.modificado_por %}
                                        por {{ cambio.modificado_por.get_full_name|default:cambio.modificado_por.username }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejar cambio de estado vía AJAX
    const estadoForm = document.getElementById('estadoForm');
    if (estadoForm) {
        estadoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Deshabilitar botón y mostrar loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Procesando...';
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Recargar la página para mostrar los cambios
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo cambiar el estado'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexión. Intenta nuevamente.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
});
</script>
{% endblock %}